name: Helm Rollback

on:
  workflow_dispatch:
    inputs:
      revision:
        description: "Helm revision number to roll back to"
        required: true

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
  EKS_CLUSTER: ${{ vars.EKS_CLUSTER }}
  HELM_RELEASE: nginx-demo

jobs:
  rollback:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/git-action
        aws-region: ${{ env.AWS_REGION }}

    - name: Build kubeconfig (NO EOF)
      run: |
        ENDPOINT=$(aws eks describe-cluster --name $EKS_CLUSTER --region $AWS_REGION --query "cluster.endpoint" --output text)
        CERT=$(aws eks describe-cluster --name $EKS_CLUSTER --region $AWS_REGION --query "cluster.certificateAuthority.data" --output text)

        mkdir -p ~/.kube
        export KUBECONFIG=$(pwd)/kubeconfig

        kubectl config set-cluster eks \
          --server="$ENDPOINT" \
          --certificate-authority=<(echo "$CERT" | base64 -d)

        kubectl config set-context eks \
          --cluster=eks \
          --user=aws

        kubectl config set-credentials aws \
          --exec-command=aws \
          --exec-api-version=client.authentication.k8s.io/v1beta1 \
          --exec-arg=eks \
          --exec-arg=get-token \
          --exec-arg=--cluster-name \
          --exec-arg=$EKS_CLUSTER \
          --exec-arg=--region \
          --exec-arg=$AWS_REGION

        kubectl config use-context eks
        echo "KUBECONFIG=$(pwd)/kubeconfig" >> $GITHUB_ENV

    - name: Perform Helm Rollback
      run: |
        helm rollback $HELM_RELEASE ${{ github.event.inputs.revision }} --wait

    - name: Slack Rollback Notification
      if: secrets.SLACK_WEBHOOK
      run: |
        payload='{"text":"⚠️ Rollback executed\n• Release: '${HELM_RELEASE}'\n• Revision: '${{ github.event.inputs.revision }}'"}'
        curl -X POST -H "Content-type: application/json" --data "$payload" "${{ secrets.SLACK_WEBHOOK }}"
