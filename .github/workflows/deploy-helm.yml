name: Build & Deploy via Helm

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
  ECR_REPO: ${{ vars.ECR_REPO }}
  EKS_CLUSTER: ${{ vars.EKS_CLUSTER }}
  ECR_REGISTRY: "${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com"
  HELM_RELEASE: nginx-demo
  CHART_PATH: charts/nginx-demo
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set IMAGE_TAG
      run: echo "IMAGE_TAG=v1.${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/git-action
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build Docker image
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPO:$IMAGE_TAG ./app

    - name: Push Docker image
      run: |
        docker push $ECR_REGISTRY/$ECR_REPO:$IMAGE_TAG

    - name: Generate kubeconfig
      run: |
        ENDPOINT=$(aws eks describe-cluster --name $EKS_CLUSTER --region $AWS_REGION --query "cluster.endpoint" --output text)
        CERT=$(aws eks describe-cluster --name $EKS_CLUSTER --region $AWS_REGION --query "cluster.certificateAuthority.data" --output text)

        mkdir -p ~/.kube
        export KUBECONFIG=$(pwd)/kubeconfig

        kubectl config set-cluster eks \
          --server="$ENDPOINT" \
          --certificate-authority=<(echo "$CERT" | base64 -d)

        kubectl config set-context eks \
          --cluster=eks \
          --user=aws

        kubectl config set-credentials aws \
          --exec-command=aws \
          --exec-api-version=client.authentication.k8s.io/v1beta1 \
          --exec-arg=eks \
          --exec-arg=get-token \
          --exec-arg=--cluster-name \
          --exec-arg=$EKS_CLUSTER \
          --exec-arg=--region \
          --exec-arg=$AWS_REGION

        kubectl config use-context eks
        echo "KUBECONFIG=$(pwd)/kubeconfig" >> $GITHUB_ENV

    - name: Verify kubectl
      run: kubectl get nodes

    - name: Helm Upgrade/Install
      run: |
        helm upgrade --install $HELM_RELEASE $CHART_PATH \
          --set image.repository=$ECR_REGISTRY/$ECR_REPO \
          --set image.tag=$IMAGE_TAG \
          --wait --timeout 5m

    - name: Slack Success Notification
      if: success() && env.SLACK_WEBHOOK != ''
      run: |
        payload='{"text":"âœ… Deployment Successful\nRelease: '${HELM_RELEASE}'\nImage: '${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}'"}'
        curl -X POST -H "Content-type: application/json" --data "$payload" "$SLACK_WEBHOOK"

    - name: Slack Failure Notification
      if: failure() && env.SLACK_WEBHOOK != ''
      run: |
