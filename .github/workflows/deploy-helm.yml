name: Build, Deploy & Auto-Rollback via Helm

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
  ECR_REPO: ${{ vars.ECR_REPO }}
  EKS_CLUSTER: ${{ vars.EKS_CLUSTER }}
  ECR_REGISTRY: "${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com"
  HELM_RELEASE: nginx-demo
  CHART_PATH: charts/nginx-demo
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set IMAGE_TAG
      run: echo "IMAGE_TAG=v1.${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/git-action
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to ECR
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build Docker image
      run: docker build -t $ECR_REGISTRY/$ECR_REPO:$IMAGE_TAG ./app

    - name: Push Docker image
      run: docker push $ECR_REGISTRY/$ECR_REPO:$IMAGE_TAG

    - name: Generate kubeconfig safely
      run: |
        ENDPOINT=$(aws eks describe-cluster --name $EKS_CLUSTER --region $AWS_REGION --query "cluster.endpoint" --output text)
        CERT=$(aws eks describe-cluster --name $EKS_CLUSTER --region $AWS_REGION --query "cluster.certificateAuthority.data" --output text)

        mkdir -p ~/.kube
        export KUBECONFIG=$(pwd)/kubeconfig

        echo "$CERT" | base64 -d > ca.crt

        kubectl config set-cluster eks \
          --server="$ENDPOINT" \
          --certificate-authority=ca.crt \
          --embed-certs=true

        kubectl config set-context eks \
          --cluster=eks \
          --user=aws

        kubectl config set-credentials aws \
          --exec-command=aws \
          --exec-api-version=client.authentication.k8s.io/v1beta1 \
          --exec-arg=eks \
          --exec-arg=get-token \
          --exec-arg=--cluster-name \
          --exec-arg=$EKS_CLUSTER \
          --exec-arg=--region \
          --exec-arg=$AWS_REGION

        kubectl config use-context eks
        echo "KUBECONFIG=$(pwd)/kubeconfig" >> $GITHUB_ENV

    - name: Verify cluster access
      run: kubectl get nodes

    - name: Helm Deploy
      run: |
        helm upgrade --install $HELM_RELEASE $CHART_PATH \
          --set image.repository=$ECR_REGISTRY/$ECR_REPO \
          --set image.tag=$IMAGE_TAG \
          --wait --timeout 5m

    - name: Store current Helm revision
      id: rev
      run: |
        REV=$(helm history $HELM_RELEASE -o json | jq '.[-1].revision')
        echo "REVISION=$REV" >> $GITHUB_ENV

    # ----------------------------------------------------------
    # HEALTH CHECK + AUTO ROLLBACK LOGIC
    # ----------------------------------------------------------
    - name: Check Deployment Health
      id: health
      run: |
        echo "Waiting for pods to become Ready..."
        sleep 10

        NOT_READY=$(kubectl get pods -l app=$HELM_RELEASE --no-headers | awk '$2 !~ /1\/1/ {print $0}' | wc -l)

        if [ "$NOT_READY" -gt 0 ]; then
          echo "Deployment failed. Pods not ready."
          echo "FAILED=true" >> $GITHUB_ENV
          exit 1
        else
          echo "Deployment healthy"
          echo "FAILED=false" >> $GITHUB_ENV
        fi

    - name: Auto Rollback if Failed
      if: failure()
      run: |
        echo "Performing Helm rollback..."
        PREV=$((REVISION - 1))
        helm rollback $HELM_RELEASE $PREV --wait --timeout 5m
        echo "Rolled back to revision $PREV"

    # ----------------------------------------------------------
    # SLACK ALWAYS NOTIFICATION
    # ----------------------------------------------------------
    - name: Slack Notification (Always)
      if: always() && env.SLACK_WEBHOOK != ''
      run: |
        if [ "${FAILED}" = "true" ]; then
          MSG="❌ Deployment FAILED → Auto Rollback Triggered"
        else
          MSG="✅ Deployment SUCCESS"
        fi

        payload="{\"text\":\"$MSG\n• Release: $HELM_RELEASE\n• Revision: $REVISION\n• Image: $ECR_REGISTRY/$ECR_REPO:$IMAGE_TAG\n• Status: ${{ job.status }}\"}"

        curl -X POST -H "Content-type: application/json" \
          --data "$payload" \
          "$SLACK_WEBHOOK"
